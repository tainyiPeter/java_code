<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>用户信息 - 微信服务号</title>
  <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 30px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #07c160;
    }

    .header h1 {
      color: #07c160;
      font-size: 24px;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
      font-size: 14px;
    }

    .info-section {
      margin-bottom: 30px;
    }

    .info-section h2 {
      color: #333;
      font-size: 18px;
      margin-bottom: 15px;
      padding-left: 10px;
      border-left: 4px solid #07c160;
    }

    .user-info {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin-right: 20px;
      border: 3px solid #07c160;
      overflow: hidden;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-details {
      flex: 1;
    }

    .user-details p {
      margin: 5px 0;
      padding: 3px 0;
    }

    .label {
      font-weight: bold;
      color: #555;
      display: inline-block;
      width: 80px;
    }

    .value {
      color: #333;
    }

    .auth-info {
      background: #f0f9ff;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #1890ff;
      margin-bottom: 20px;
    }

    .buttons {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 30px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn-primary {
      background: #07c160;
      color: white;
    }

    .btn-primary:hover {
      background: #06ad56;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(7, 193, 96, 0.3);
    }

    .btn-secondary {
      background: #1890ff;
      color: white;
    }

    .btn-secondary:hover {
      background: #1479d6;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(24, 144, 255, 0.3);
    }

    .btn-outline {
      background: transparent;
      color: #07c160;
      border: 2px solid #07c160;
    }

    .btn-outline:hover {
      background: #07c160;
      color: white;
    }

    .loading {
      text-align: center;
      padding: 40px;
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #07c160;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-message {
      background: #fff2f0;
      border: 1px solid #ffccc7;
      color: #d4380d;
      padding: 15px;
      border-radius: 6px;
      margin: 20px 0;
      text-align: center;
    }

    .debug-info {
      background: #f6ffed;
      border: 1px solid #b7eb8f;
      padding: 15px;
      border-radius: 6px;
      margin-top: 30px;
      font-family: monospace;
      font-size: 12px;
      overflow-x: auto;
    }

    .debug-title {
      color: #52c41a;
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .footer {
      text-align: center;
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #eee;
      color: #999;
      font-size: 12px;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      .user-info {
        flex-direction: column;
        text-align: center;
      }

      .avatar {
        margin-right: 0;
        margin-bottom: 15px;
      }

      .buttons {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>微信用户信息</h1>
    <p>查看您的微信授权信息和用户资料</p>
  </div>

  <!-- 加载状态 -->
  <div id="loading" class="loading">
    <div class="loading-spinner"></div>
    <p>正在获取用户信息...</p>
  </div>

  <!-- 错误信息 -->
  <div id="error" class="error-message" style="display: none;">
    <p id="errorText"></p>
    <button onclick="retryGetUserInfo()" class="btn btn-outline" style="margin-top: 10px;">重试</button>
  </div>

  <!-- 用户信息展示区域 -->
  <div id="content" style="display: none;">
    <!-- 用户基本信息 -->
    <div class="info-section">
      <h2>基本信息</h2>
      <div class="user-info">
        <div class="avatar">
          <img id="avatar" src="" alt="用户头像">
        </div>
        <div class="user-details">
          <p><span class="label">昵称:</span> <span id="nickname" class="value"></span></p>
          <p><span class="label">OpenID:</span> <span id="openid" class="value"></span></p>
          <p><span class="label">性别:</span> <span id="gender" class="value"></span></p>
          <p><span class="label">地区:</span> <span id="location" class="value"></span></p>
          <p><span class="label">国家:</span> <span id="country" class="value"></span></p>
        </div>
      </div>
    </div>

    <!-- 授权信息 -->
    <div class="info-section">
      <h2>授权信息</h2>
      <div class="auth-info">
        <p><span class="label">授权状态:</span> <span id="authStatus" class="value">已授权</span></p>
        <p><span class="label">授权时间:</span> <span id="authTime" class="value"></span></p>
        <p><span class="label">授权范围:</span> <span id="authScope" class="value">snsapi_userinfo</span></p>
      </div>
    </div>

    <!-- 操作按钮 -->
    <div class="buttons">
      <a href="/" class="btn btn-primary">返回首页</a>
      <button onclick="shareUserInfo()" class="btn btn-secondary">分享名片</button>
      <button onclick="clearUserInfo()" class="btn btn-outline">清除信息</button>
    </div>

    <!-- 调试信息（开发时可显示） -->
    <div class="debug-info" id="debugInfo" style="display: none;">
      <div class="debug-title">调试信息</div>
      <div>URL参数 - Code: <span id="debugCode"></span></div>
      <div>URL参数 - State: <span id="debugState"></span></div>
      <div>完整用户信息: <pre id="debugUserInfo"></pre></div>
    </div>
  </div>
</div>

<div class="footer">
  <p>© 2026 微信服务号测试系统 | Spring Boot + Thymeleaf</p>
  <p>当前时间: <span id="currentTime"></span></p>
</div>

<script>
  // 初始化
  document.addEventListener('DOMContentLoaded', function() {
    // 显示当前时间
    updateCurrentTime();

    // 显示调试信息中的URL参数
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const state = urlParams.get('state');

    document.getElementById('debugCode').textContent = code || '无';
    document.getElementById('debugState').textContent = state || '无';

    // 显示授权时间
    document.getElementById('authTime').textContent = new Date().toLocaleString();

    // 如果有授权码，获取用户信息
    if (code) {
      getUserInfo(code, state);
    } else {
      // 没有授权码，显示错误
      showError('未找到授权码，请重新登录');
    }

    // 初始化微信JS-SDK（可选）
    initWxSdk();
  });

  // 获取用户信息
  function getUserInfo(code, state) {
    fetch(`/wechat/oauth/callback?code=${code}&state=${state}`)
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP错误: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              if (data.code === 0) {
                // 获取用户信息成功
                displayUserInfo(data.data);
              } else {
                throw new Error(data.message || '获取用户信息失败');
              }
            })
            .catch(error => {
              console.error('获取用户信息失败:', error);
              showError(`获取用户信息失败: ${error.message}`);
            });
  }

  // 显示用户信息
  function displayUserInfo(data) {
    const user = data.userInfo;

    // 设置用户信息
    document.getElementById('avatar').src = user.headImgUrl || 'https://via.placeholder.com/80';
    document.getElementById('nickname').textContent = user.nickname || '未知';
    document.getElementById('openid').textContent = data.openId || '未知';

    // 性别转换
    const genderMap = { '1': '男', '2': '女', '0': '未知' };
    document.getElementById('gender').textContent = genderMap[user.sex] || '未知';

    // 地区信息
    document.getElementById('location').textContent =
            (user.province || '') + ' ' + (user.city || '');
    document.getElementById('country').textContent = user.country || '未知';

    // 显示完整用户信息（调试用）
    document.getElementById('debugUserInfo').textContent = JSON.stringify(user, null, 2);

    // 隐藏加载状态，显示内容
    document.getElementById('loading').style.display = 'none';
    document.getElementById('content').style.display = 'block';

    // 可选：显示调试信息（开发时可开启）
    // document.getElementById('debugInfo').style.display = 'block';

    // 保存到本地存储（可选）
    try {
      localStorage.setItem('wechatUserInfo', JSON.stringify(user));
      localStorage.setItem('wechatOpenId', data.openId);
    } catch (e) {
      console.warn('无法保存到本地存储:', e);
    }
  }

  // 显示错误信息
  function showError(message) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
    document.getElementById('errorText').textContent = message;
    console.error('错误:', message);
  }

  // 重试获取用户信息
  function retryGetUserInfo() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const state = urlParams.get('state');

    if (code) {
      document.getElementById('error').style.display = 'none';
      document.getElementById('loading').style.display = 'block';
      getUserInfo(code, state);
    } else {
      // 如果没有code，重定向到登录页
      window.location.href = '/login';
    }
  }

  // 分享用户名片（需要JS-SDK支持）
  function shareUserInfo() {
    const nickname = document.getElementById('nickname').textContent;
    const avatar = document.getElementById('avatar').src;

    alert(`分享 ${nickname} 的名片功能需要JS-SDK支持`);
    // 实际实现需要初始化微信JS-SDK并调用分享API
  }

  // 清除用户信息
  function clearUserInfo() {
    if (confirm('确定要清除用户信息吗？')) {
      try {
        localStorage.removeItem('wechatUserInfo');
        localStorage.removeItem('wechatOpenId');
        sessionStorage.clear();
      } catch (e) {
        console.warn('清除存储失败:', e);
      }

      // 重定向到首页
      window.location.href = '/';
    }
  }

  // 初始化微信JS-SDK
  function initWxSdk() {
    const currentUrl = window.location.href.split('#')[0];

    fetch(`/wechat/js-sdk/config?url=${encodeURIComponent(currentUrl)}`)
            .then(response => response.json())
            .then(data => {
              if (data.code === 0) {
                const config = data.data;

                wx.config({
                  debug: false, // 生产环境设为false
                  appId: config.appId,
                  timestamp: config.timestamp,
                  nonceStr: config.nonceStr,
                  signature: config.signature,
                  jsApiList: config.jsApiList || [
                    'onMenuShareTimeline',
                    'onMenuShareAppMessage',
                    'updateAppMessageShareData',
                    'updateTimelineShareData'
                  ]
                });

                wx.ready(function() {
                  console.log('JS-SDK 初始化成功');
                  setupShare();
                });

                wx.error(function(res) {
                  console.error('JS-SDK 初始化失败:', res);
                });
              }
            })
            .catch(error => {
              console.warn('JS-SDK配置获取失败:', error);
            });
  }

  // 设置分享
  function setupShare() {
    const nickname = document.getElementById('nickname').textContent || '微信用户';

    // 分享给朋友
    wx.updateAppMessageShareData({
      title: `${nickname}的微信名片`,
      desc: '这是我的微信名片，欢迎关注',
      link: window.location.href,
      imgUrl: document.getElementById('avatar').src || 'https://via.placeholder.com/200',
      success: function() {
        console.log('分享给朋友设置成功');
      }
    });

    // 分享到朋友圈
    wx.updateTimelineShareData({
      title: `${nickname}的微信名片分享`,
      link: window.location.href,
      imgUrl: document.getElementById('avatar').src || 'https://via.placeholder.com/200',
      success: function() {
        console.log('分享到朋友圈设置成功');
      }
    });
  }

  // 更新当前时间
  function updateCurrentTime() {
    const now = new Date();
    document.getElementById('currentTime').textContent =
            now.toLocaleDateString() + ' ' + now.toLocaleTimeString();

    // 每秒更新一次
    setTimeout(updateCurrentTime, 1000);
  }

  // 检查本地是否有缓存的用户信息
  function checkLocalStorage() {
    try {
      const savedUser = localStorage.getItem('wechatUserInfo');
      if (savedUser && !window.location.search.includes('code=')) {
        const user = JSON.parse(savedUser);
        // 可以在这里显示缓存的用户信息
        console.log('找到缓存的用户信息:', user);
      }
    } catch (e) {
      console.warn('读取本地存储失败:', e);
    }
  }

  // 页面加载时检查本地存储
  checkLocalStorage();
</script>
</body>
</html>
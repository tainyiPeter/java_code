<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯·å…ˆå…³æ³¨å…¬ä¼—å·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-top: 40px;
            position: relative;
            overflow: hidden;
        }
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #07c160, #007bff);
        }
        h1 {
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            font-size: 16px;
            margin-bottom: 30px;
            line-height: 1.5;
        }
        .qrcode-container {
            margin: 30px 0;
            padding: 25px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            position: relative;
            border: 2px dashed #ddd;
        }
        .qrcode-container::before {
            content: 'â¬‡ï¸';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
        }
        .qrcode {
            width: 240px;
            height: 240px;
            margin: 0 auto;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border: 4px solid white;
            background: white;
        }
        .qrcode img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .qrcode-loading {
            width: 240px;
            height: 240px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            border-radius: 10px;
            border: 4px solid white;
        }
        .qrcode-loading .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #07c160;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tip {
            color: #666;
            font-size: 14px;
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.8);
            border-radius: 8px;
            line-height: 1.6;
        }
        .steps {
            text-align: left;
            margin: 35px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            border-left: 4px solid #07c160;
        }
        .steps h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
        }
        .steps h3::before {
            content: 'ğŸ“‹';
            margin-right: 10px;
        }
        .steps ol {
            margin: 0;
            padding-left: 20px;
            color: #555;
        }
        .steps li {
            margin: 12px 0;
            line-height: 1.6;
            padding-left: 5px;
        }
        .steps li::marker {
            color: #07c160;
            font-weight: bold;
        }
        .button-group {
            margin: 30px 0;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 14px 35px;
            border-radius: 50px;
            text-decoration: none;
            font-size: 16px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 160px;
            gap: 8px;
        }
        .btn-check {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0,123,255,0.3);
        }
        .btn-check:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,123,255,0.4);
        }
        .btn-check:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-refresh {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(108,117,125,0.3);
        }
        .btn-refresh:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108,117,125,0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(40,167,69,0.3);
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40,167,69,0.4);
        }
        #checkResult {
            margin: 25px 0;
            padding: 20px;
            border-radius: 12px;
            display: none;
            animation: fadeIn 0.5s ease;
            border-left: 4px solid;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .result-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-left-color: #28a745;
        }
        .result-error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-left-color: #dc3545;
        }
        .result-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            color: #0c5460;
            border-left-color: #17a2b8;
        }
        .countdown {
            font-size: 14px;
            color: #666;
            margin-top: 25px;
            padding: 15px;
            background: rgba(0,0,0,0.03);
            border-radius: 10px;
        }
        .countdown-number {
            font-weight: bold;
            color: #07c160;
            font-size: 18px;
            margin: 0 5px;
        }
        .footer-tip {
            margin-top: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.02);
            border-radius: 12px;
            text-align: left;
        }
        .footer-tip h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
        }
        .footer-tip h4::before {
            content: 'ğŸ’¡';
            margin-right: 10px;
        }
        .footer-tip p {
            color: #666;
            font-size: 14px;
            margin: 8px 0;
            line-height: 1.6;
        }
        .hidden {
            display: none;
        }
        .icon {
            font-size: 20px;
        }
        .success-icon {
            color: #28a745;
            font-size: 48px;
            margin-bottom: 20px;
            animation: bounce 1s ease infinite alternate;
        }
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }
        .auto-check-info {
            margin-top: 20px;
            padding: 12px;
            background: rgba(0,123,255,0.1);
            border-radius: 8px;
            color: #0056b3;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- æˆåŠŸå…³æ³¨åçš„å†…å®¹ï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div id="successContent" class="hidden">
        <div class="success-icon">ğŸ‰</div>
        <h1>å…³æ³¨æˆåŠŸï¼</h1>
        <p class="subtitle">æ‚¨å·²æˆåŠŸå…³æ³¨å…¬ä¼—å·ï¼Œæ­£åœ¨ä¸ºæ‚¨è·³è½¬...</p>

        <div id="successResult" class="result-success">
            <p>âœ“ ç³»ç»Ÿæ£€æµ‹åˆ°æ‚¨å·²å…³æ³¨å…¬ä¼—å·</p>
            <p>æ­£åœ¨è·å–æ‚¨çš„æˆæƒä¿¡æ¯ï¼Œè¯·ç¨å€™...</p>
        </div>

        <div class="countdown">
            é¡µé¢å°†åœ¨ <span id="countdownNumber" class="countdown-number">5</span> ç§’åè‡ªåŠ¨è·³è½¬
        </div>

        <div class="button-group">
            <button onclick="continueToApp()" class="btn btn-success">
                <span class="icon">ğŸš€</span> ç«‹å³è·³è½¬
            </button>
            <button onclick="refreshPage()" class="btn btn-refresh">
                <span class="icon">â†»</span> é‡æ–°æ£€æµ‹
            </button>
        </div>
    </div>

    <!-- å…³æ³¨å¼•å¯¼å†…å®¹ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰ -->
    <div id="guideContent">
        <h1>è¯·å…ˆå…³æ³¨æµ‹è¯•å·</h1>
        <p class="subtitle">ä½¿ç”¨æ­¤åŠŸèƒ½éœ€è¦å…ˆå…³æ³¨æˆ‘ä»¬çš„æµ‹è¯•å·ï¼Œå…³æ³¨åå³å¯ä½¿ç”¨å®Œæ•´åŠŸèƒ½</p>

        <div class="qrcode-container">
            <p><strong>ğŸ“± æ‰«ç å…³æ³¨æµ‹è¯•å·ï¼š</strong></p>

            <!-- äºŒç»´ç æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="qrcodeImage" class="qrcode">
                <img th:src="${qrCodeUrl}" alt="æµ‹è¯•å·äºŒç»´ç " style="width:100%;height:100%;">
            </div>

            <!-- äºŒç»´ç åŠ è½½ä¸­ -->
            <div id="qrcodeLoading" class="qrcode-loading">
                <div class="spinner"></div>
            </div>

            <p class="tip">
                <span style="color:#ff6b6b;">âš ï¸ æ³¨æ„ï¼š</span><br>
                è¯·ä½¿ç”¨ <strong>å¾®ä¿¡</strong> æ‰«æä¸Šæ–¹äºŒç»´ç <br>
                å…³æ³¨æˆåŠŸåï¼Œè¯·è¿”å›æ­¤é¡µé¢ç‚¹å‡»"æˆ‘å·²å…³æ³¨"æŒ‰é’®
            </p>
        </div>

        <div class="steps">
            <h3>æ“ä½œæ­¥éª¤ï¼š</h3>
            <ol>
                <li>æ‰“å¼€å¾®ä¿¡ï¼Œç‚¹å‡»å³ä¸Šè§’"+" â†’ "æ‰«ä¸€æ‰«"</li>
                <li>æ‰«æä¸Šæ–¹äºŒç»´ç ï¼Œè¿›å…¥å…¬ä¼—å·é¡µé¢</li>
                <li>ç‚¹å‡»"å…³æ³¨å…¬ä¼—å·"æŒ‰é’®å®Œæˆå…³æ³¨</li>
                <li>è¿”å›æ­¤é¡µé¢ï¼Œç‚¹å‡»ä¸‹æ–¹"æˆ‘å·²å…³æ³¨"æŒ‰é’®</li>
                <li>ç³»ç»Ÿå°†è‡ªåŠ¨è·³è½¬åˆ°ç›®æ ‡é¡µé¢</li>
            </ol>
        </div>

        <!-- è‡ªåŠ¨æ£€æŸ¥æç¤º -->
        <div class="auto-check-info">
            <span class="icon pulse">ğŸ”</span>
            <span>ç³»ç»Ÿæ­£åœ¨è‡ªåŠ¨æ£€æµ‹å…³æ³¨çŠ¶æ€...</span>
        </div>

        <div class="button-group">
            <button onclick="checkSubscribe()" class="btn btn-check" id="checkButton">
                <span class="icon">âœ…</span> æˆ‘å·²å…³æ³¨ï¼Œç»§ç»­
            </button>
            <button onclick="refreshPage()" class="btn btn-refresh">
                <span class="icon">â†»</span> åˆ·æ–°é¡µé¢
            </button>
        </div>

        <!-- æ£€æŸ¥ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
        <div id="checkResult"></div>

        <!-- å€’è®¡æ—¶æç¤º -->
        <div id="countdownInfo" class="countdown hidden">
            æ£€æµ‹åˆ°å·²å…³æ³¨ï¼Œ<span id="autoJumpCountdown" class="countdown-number">3</span> ç§’åè‡ªåŠ¨è·³è½¬
            <button onclick="cancelAutoJump()" style="margin-left:10px;padding:4px 12px;background:transparent;color:#666;border:1px solid #666;border-radius:4px;cursor:pointer;">
                å–æ¶ˆ
            </button>
        </div>

        <div class="footer-tip">
            <h4>å¦‚æœå·²ç»å…³æ³¨ä½†ä»æç¤ºé”™è¯¯ï¼š</h4>
            <p>1. è¯·ç¡®è®¤æ‰«æçš„æ˜¯å½“å‰é¡µé¢çš„äºŒç»´ç </p>
            <p>2. å°è¯•å–æ¶ˆå…³æ³¨åé‡æ–°å…³æ³¨</p>
            <p>3. ç­‰å¾…1-2åˆ†é’Ÿååˆ·æ–°é¡µé¢é‡è¯•</p>
            <p>4. æ¸…é™¤å¾®ä¿¡ç¼“å­˜åé‡æ–°è¿›å…¥</p>
            <p>5. æˆ–è”ç³»å®¢æœè·å–å¸®åŠ©</p>
        </div>
    </div>
</div>

<script>
    // å…¨å±€å˜é‡
    let checking = false;
    let autoCheckInterval = null;
    let countdownInterval = null;
    let autoJumpCountdown = 3;
    let checkAttempts = 0;
    const MAX_CHECK_ATTEMPTS = 180; // æœ€å¤šæ£€æŸ¥3åˆ†é’Ÿï¼ˆ180æ¬¡ï¼‰

    // DOMå…ƒç´ 
    const guideContent = document.getElementById('guideContent');
    const successContent = document.getElementById('successContent');
    const checkResult = document.getElementById('checkResult');
    const checkButton = document.getElementById('checkButton');
    const countdownInfo = document.getElementById('countdownInfo');
    const countdownNumber = document.getElementById('countdownNumber');
    const autoJumpCountdownEl = document.getElementById('autoJumpCountdown');
    const qrcodeImage = document.getElementById('qrcodeImage');
    const qrcodeLoading = document.getElementById('qrcodeLoading');

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
        console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');

        // æ˜¾ç¤ºäºŒç»´ç ï¼ˆå¦‚æœå·²åŠ è½½ï¼‰
        if (document.querySelector('.qrcode img').getAttribute('src')) {
            qrcodeLoading.style.display = 'none';
            qrcodeImage.style.display = 'block';
        } else {
            // å¦‚æœäºŒç»´ç åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºå ä½ç¬¦
            setTimeout(() => {
                qrcodeLoading.style.display = 'none';
                qrcodeImage.style.display = 'block';
                qrcodeImage.innerHTML = '<div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f0f0f0;color:#666;padding:20px;text-align:center;">' +
                    '<div style="font-size:48px;margin-bottom:10px;">ğŸ“±</div>' +
                    '<div style="font-size:14px;">è¯·åˆ·æ–°é¡µé¢é‡æ–°åŠ è½½äºŒç»´ç </div>' +
                    '</div>';
            }, 3000);
        }

        // 3ç§’åå¼€å§‹è‡ªåŠ¨æ£€æŸ¥
        setTimeout(() => {
            console.log('å¼€å§‹è‡ªåŠ¨æ£€æŸ¥å…³æ³¨çŠ¶æ€...');
            startAutoCheck();
        }, 3000);
    });

    // æ‰‹åŠ¨æ£€æŸ¥å…³æ³¨çŠ¶æ€
    function checkSubscribe() {
        if (checking) return;

        checking = true;
        const originalText = checkButton.textContent;
        checkButton.innerHTML = '<span class="icon">â³</span> æ£€æŸ¥ä¸­...';
        checkButton.disabled = true;

        checkResult.style.display = 'none';
        countdownInfo.classList.add('hidden');

        // è°ƒç”¨æ£€æŸ¥æ¥å£
        fetch('/wechat/check-subscribe')
            .then(response => response.json())
            .then(handleCheckResponse)
            .catch(handleCheckError)
            .finally(() => {
                checking = false;
                checkButton.innerHTML = '<span class="icon">âœ…</span> ' + originalText;
                checkButton.disabled = false;
            });
    }

    // å¤„ç†æ£€æŸ¥å“åº”
    function handleCheckResponse(data) {
        console.log('æ£€æŸ¥å“åº”:', data);

        if (data.code === 0 && data.data.subscribed) {
            // å·²å…³æ³¨ï¼Œæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showSuccess();
        } else {
            // æœªå…³æ³¨æˆ–æ£€æŸ¥å¤±è´¥
            showResult('error',
                data.code === -1 ? 'âœ— ' + data.message : 'âœ— æ£€æµ‹åˆ°æ‚¨å°šæœªå…³æ³¨ï¼Œè¯·å…ˆå…³æ³¨æµ‹è¯•å·',
                'è¯·ç¡®è®¤å·²å®Œæˆå…³æ³¨æ“ä½œï¼Œç„¶åç‚¹å‡»"æˆ‘å·²å…³æ³¨"æŒ‰é’®é‡è¯•ã€‚'
            );
        }
    }

    // å¤„ç†æ£€æŸ¥é”™è¯¯
    function handleCheckError(error) {
        console.error('æ£€æŸ¥å¤±è´¥:', error);
        showResult('error', 'âœ— æ£€æŸ¥å¤±è´¥ï¼Œè¯·é‡è¯•', 'ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚');
    }

    // æ˜¾ç¤ºç»“æœ
    function showResult(type, title, message) {
        checkResult.className = type === 'success' ? 'result-success' :
            type === 'info' ? 'result-info' : 'result-error';
        checkResult.innerHTML = `
            <p style="font-weight:bold;margin-bottom:8px;">${title}</p>
            <p style="font-size:14px;margin:0;">${message}</p>
        `;
        checkResult.style.display = 'block';
    }

    // æ˜¾ç¤ºå…³æ³¨æˆåŠŸ
    function showSuccess() {
        // æ˜¾ç¤ºæˆåŠŸå†…å®¹ï¼Œéšè—å¼•å¯¼å†…å®¹
        guideContent.style.display = 'none';
        successContent.classList.remove('hidden');

        // å¼€å§‹å€’è®¡æ—¶
        startCountdown();
    }

    // å¼€å§‹å€’è®¡æ—¶
    function startCountdown() {
        let countdown = 5;
        countdownNumber.textContent = countdown;

        countdownInterval = setInterval(() => {
            countdown--;
            countdownNumber.textContent = countdown;

            if (countdown <= 0) {
                clearInterval(countdownInterval);
                continueToApp();
            }
        }, 1000);
    }

    // ç»§ç»­åˆ°åº”ç”¨
    function continueToApp() {
        // è·å–redirectUriå‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        let redirectUri = urlParams.get('redirectUri');

        if (!redirectUri) {
            // å°è¯•ä»sessionStorageè·å–
            redirectUri = sessionStorage.getItem('pendingRedirectUri');
        }

        if (!redirectUri) {
            redirectUri = '/user/center'; // é»˜è®¤è·³è½¬åˆ°ç”¨æˆ·ä¸­å¿ƒ
        }

        console.log('è·³è½¬åˆ°:', redirectUri);

        // æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
        if (autoCheckInterval) clearInterval(autoCheckInterval);
        if (countdownInterval) clearInterval(countdownInterval);

        // è·³è½¬åˆ°æˆæƒé¡µé¢
        window.location.href = '/wechat/unified-auth?redirectUri=' +
            encodeURIComponent(redirectUri) + '&forceAuth=true&t=' + Date.now();
    }

    // å¼€å§‹è‡ªåŠ¨æ£€æŸ¥
    function startAutoCheck() {
        if (autoCheckInterval) {
            clearInterval(autoCheckInterval);
        }

        checkAttempts = 0;

        autoCheckInterval = setInterval(() => {
            if (checkAttempts >= MAX_CHECK_ATTEMPTS) {
                console.log('è¾¾åˆ°æœ€å¤§æ£€æŸ¥æ¬¡æ•°ï¼Œåœæ­¢è‡ªåŠ¨æ£€æŸ¥');
                clearInterval(autoCheckInterval);
                return;
            }

            fetch('/wechat/check-subscribe')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 0 && data.data.subscribed) {
                        // å·²å…³æ³¨ï¼Œåœæ­¢è‡ªåŠ¨æ£€æŸ¥
                        clearInterval(autoCheckInterval);

                        // æ˜¾ç¤ºè‡ªåŠ¨è·³è½¬æç¤º
                        countdownInfo.classList.remove('hidden');
                        startAutoJumpCountdown();
                    }
                })
                .catch(error => {
                    console.error('è‡ªåŠ¨æ£€æŸ¥å¤±è´¥:', error);
                });

            checkAttempts++;
        }, 1000); // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡

        console.log('è‡ªåŠ¨æ£€æŸ¥å·²å¯åŠ¨ï¼Œæœ€å¤šæ£€æŸ¥', MAX_CHECK_ATTEMPTS, 'æ¬¡');
    }

    // å¼€å§‹è‡ªåŠ¨è·³è½¬å€’è®¡æ—¶
    function startAutoJumpCountdown() {
        autoJumpCountdown = 3;
        autoJumpCountdownEl.textContent = autoJumpCountdown;

        const jumpInterval = setInterval(() => {
            autoJumpCountdown--;
            autoJumpCountdownEl.textContent = autoJumpCountdown;

            if (autoJumpCountdown <= 0) {
                clearInterval(jumpInterval);
                checkSubscribe(); // è§¦å‘æ‰‹åŠ¨æ£€æŸ¥ï¼Œæ˜¾ç¤ºæˆåŠŸé¡µé¢
            }
        }, 1000);
    }

    // å–æ¶ˆè‡ªåŠ¨è·³è½¬
    function cancelAutoJump() {
        countdownInfo.classList.add('hidden');
        if (autoCheckInterval) {
            clearInterval(autoCheckInterval);
        }
    }

    // åˆ·æ–°é¡µé¢
    function refreshPage() {
        // æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
        if (autoCheckInterval) clearInterval(autoCheckInterval);
        if (countdownInterval) clearInterval(countdownInterval);

        // é‡æ–°åŠ è½½é¡µé¢
        window.location.reload();
    }

    // äºŒç»´ç åŠ è½½å¤±è´¥å¤„ç†
    document.querySelector('.qrcode img').onerror = function() {
        console.error('äºŒç»´ç åŠ è½½å¤±è´¥');
        qrcodeLoading.style.display = 'none';
        qrcodeImage.style.display = 'block';
        qrcodeImage.innerHTML = '<div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f0f0f0;color:#666;padding:20px;text-align:center;">' +
            '<div style="font-size:48px;margin-bottom:10px;">âŒ</div>' +
            '<div style="font-size:14px;margin-bottom:10px;">äºŒç»´ç åŠ è½½å¤±è´¥</div>' +
            '<button onclick="refreshPage()" style="padding:8px 16px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;">ç‚¹å‡»åˆ·æ–°</button>' +
            '</div>';
    };

    // äºŒç»´ç åŠ è½½æˆåŠŸå¤„ç†
    document.querySelector('.qrcode img').onload = function() {
        console.log('äºŒç»´ç åŠ è½½æˆåŠŸ');
        qrcodeLoading.style.display = 'none';
        qrcodeImage.style.display = 'block';
    };

    // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†ï¼ˆç”¨æˆ·åˆ‡æ¢æ ‡ç­¾é¡µæ—¶æš‚åœè‡ªåŠ¨æ£€æŸ¥ï¼‰
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            // é¡µé¢éšè—ï¼Œæš‚åœè‡ªåŠ¨æ£€æŸ¥
            if (autoCheckInterval) {
                clearInterval(autoCheckInterval);
                autoCheckInterval = null;
            }
        } else {
            // é¡µé¢æ˜¾ç¤ºï¼Œé‡æ–°å¼€å§‹è‡ªåŠ¨æ£€æŸ¥
            if (!autoCheckInterval && checkAttempts < MAX_CHECK_ATTEMPTS) {
                startAutoCheck();
            }
        }
    });
</script>
</body>
</html>